/* Teilnehmer: Link auswerten (mit PIN-Wiederfreischaltung) */
showResultBtn.addEventListener('click', () => {
  const params = new URLSearchParams(window.location.search);
  const tokenParam = params.get('t');

  if (!tokenParam) {
    resultMsg.textContent = "Ungültiger oder unvollständiger Link.";
    return;
  }

  let pair;
  try {
    const decodedToken = decodeURIComponent(tokenParam);
    pair = decryptData(decodedToken);
  } catch (e) {
    resultMsg.textContent = "Fehler beim Lesen der Daten.";
    return;
  }

  if (!pair || !pair.id || !pair.myName || !pair.targetName) {
    resultMsg.textContent = "Daten im Link sind ungültig.";
    return;
  }

  const usedKey = LS_USED_PREFIX + pair.id;
  const pinKey = LS_PIN_PREFIX + pair.id;

  const typedName = userNameInput.value.trim();
  if (!typedName) {
    resultMsg.textContent = "Bitte zuerst deinen Namen eingeben.";
    return;
  }

  if (typedName !== pair.myName) {
    resultMsg.textContent = "Der Name passt nicht zu diesem Link.";
    return;
  }

  // Link wurde schon benutzt → PIN-Pfad
  if (localStorage.getItem(usedKey) === "true") {
    const savedPin = localStorage.getItem(pinKey);
    if (!savedPin) {
      resultMsg.textContent = "Dieser Link wurde bereits verwendet (kein PIN gesetzt).";
      return;
    }

    let entered = prompt(
      "Dieser Link wurde bereits verwendet.\n\nBitte deinen 4-stelligen PIN eingeben (nur Ziffern):"
    );
    if (entered === null) {
      resultMsg.textContent = "PIN-Eingabe abgebrochen.";
      return;
    }

    // so lange nachfragen, bis 4 Ziffern oder Abbruch
    while (!/^[0-9]{4}$/.test(entered)) {
      entered = prompt("Der PIN muss aus genau 4 Ziffern bestehen.\nBitte erneut eingeben oder Abbrechen:");
      if (entered === null) {
        resultMsg.textContent = "PIN-Eingabe abgebrochen.";
        return;
      }
    }

    if (entered !== savedPin) {
      resultMsg.textContent = "Falscher PIN.";
      return;
    }

    // korrekter PIN → Zuordnung erneut anzeigen
    resultMsg.textContent = `Du beschenkst: ${pair.targetName}`;
    if (bgMusic) {
      bgMusic.play().catch(() => {});
    }
    return;
  }

  // Erster Aufruf: Ergebnis anzeigen & optional PIN setzen
  resultMsg.textContent = `Du beschenkst: ${pair.targetName}`;
  localStorage.setItem(usedKey, "true");

  let pin = prompt(
    "Wenn du später nochmal nachschauen willst, kannst du jetzt einen 4-stelligen Zahlencode festlegen.\n" +
    "Lass das Feld leer oder drücke Abbrechen, wenn du keinen PIN setzen möchtest.\n\nPIN (4 Ziffern):"
  );

  if (pin !== null && pin !== "") {
    // so lange nachfragen, bis 4 Ziffern oder Abbruch
    while (!/^[0-9]{4}$/.test(pin)) {
      pin = prompt("Der PIN muss aus genau 4 Ziffern bestehen.\nBitte erneut eingeben oder Abbrechen:");
      if (pin === null || pin === "") {
        // doch keinen PIN setzen
        pin = "";
        break;
      }
    }
    if (pin && /^[0-9]{4}$/.test(pin)) {
      localStorage.setItem(pinKey, pin);
    }
  }

  if (bgMusic) {
    bgMusic.play().catch(() => {});
  }
});
